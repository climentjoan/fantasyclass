(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{"8V47":function(e,t,n){"use strict";var s=n("AlXQ");n.n(s).a},AlXQ:function(e,t,n){var s=n("cgQY");"string"==typeof s&&(s=[[e.i,s,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n("aET+")(s,r);s.locals&&(e.exports=s.locals)},ImGi:function(e,t,n){"use strict";n.r(t);var s=n("o0o1"),r=n.n(s),a=n("o0O0"),o=n("kbJ5"),i=n.n(o),c=(n("R2j2"),n("Jgta"));n("5x/H"),n("Zs65"),n("WI49");c.a.initializeApp({apiKey:"AIzaSyCTkrUugiome3NI6GchcoYNzQNJolIoiSs",authDomain:"ftest-cd388.firebaseapp.com",databaseURL:"https://test-cd388.firebaseio.com",projectId:"test-cd388",storageBucket:"test-cd388.appspot.com",messagingSenderId:"605858092563",appId:"1:605858092563:web:7c5b7f6cb791deda7051e6"});var d=c.a,u=c.a.firestore(),m=c.a.storage().ref(),f=u.collection("users"),l=u.collection("chatRooms"),p=m.child("files"),h=(d.firestore.FieldValue.serverTimestamp(),d.firestore.FieldValue.delete()),g=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e){var n=e.seconds?new Date(1e3*e.seconds):e;if("HH:mm"===t)return"".concat(v(n.getHours(),2),":").concat(v(n.getMinutes(),2));if("DD MMMM YYYY"===t){var s={month:"long",year:"numeric",day:"numeric"};return"".concat(new Intl.DateTimeFormat("en-GB",s).format(n))}if("DD/MM/YY"===t){var r={month:"numeric",year:"numeric",day:"numeric"};return"".concat(new Intl.DateTimeFormat("en-GB",r).format(n))}if("DD MMMM, HH:mm"===t){var a={month:"long",day:"numeric"};return"".concat(new Intl.DateTimeFormat("en-GB",a).format(n),", ").concat(v(n.getHours(),2),":").concat(v(n.getMinutes(),2))}return n}},v=function(e,t){return String(e).padStart(t,"0")},I=function(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()},M=n("bEKI");function w(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function R(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?w(Object(n),!0).forEach((function(t){b(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function y(e,t,n,s,r,a,o){try{var i=e[a](o),c=i.value}catch(e){return void n(e)}i.done?t(c):Promise.resolve(c).then(s,r)}function U(e){return function(){var t=this,n=arguments;return new Promise((function(s,r){var a=e.apply(t,n);function o(e){y(a,s,r,o,i,"next",e)}function i(e){y(a,s,r,o,i,"throw",e)}o(void 0)}))}}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n("6nsN");var x={props:["currentUserId","currentUsername"],components:{ChatWindow:i.a},data:function(){return b({perPage:20,loadingRooms:!0,selectedRoom:null,messages:[],messagesLoaded:!1,start:null,end:null,roomsListeners:[],listeners:[],disableForm:!1,addNewRoom:null,addRoomUsername:"",inviteRoomId:null,invitedUsername:"",removeRoomId:null,removeUserId:"",removeUsers:[],menuActions:[{name:"inviteUser",title:"Invite User"},{name:"removeUser",title:"Remove User"},{name:"deleteRoom",title:"Delete Room"}],styles:{container:{borderRadius:"4px"}},rooms:[]},"messages",[])},mounted:function(){var e=this;axios.get("/inbox/token").then((function(t){d.auth().signInWithCustomToken(t.data).then((function(t){e.createUser().then((function(t){e.fetchRooms(),e.updateUserOnlineStatus()}))})).catch((function(e){console.log(e)}))}))},destroyed:function(){this.resetRooms()},methods:{createUser:function(){var e=this;return U(r.a.mark((function t(){return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,f.doc(e.currentUserId).set({_id:e.currentUserId,username:e.currentUsername});case 2:case"end":return t.stop()}}),t)})))()},messagesRef:function(e){return l.doc(e).collection("messages")},resetRooms:function(){this.loadingRooms=!0,this.rooms=[],this.roomsListeners.forEach((function(e){return e()})),this.resetMessages()},resetMessages:function(){this.messages=[],this.messagesLoaded=!1,this.start=null,this.end=null,this.listeners.forEach((function(e){return e()})),this.listeners=[]},fetchRooms:function(){var e=this;return U(r.a.mark((function t(){var s,a,o,i,c,d;return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.resetRooms(),s=l.where("users","array-contains",e.currentUserId),t.next=4,s.get();case 4:return a=t.sent,o=[],i=[],c=[],a.forEach((function(t){o[t.id]=R(R({},t.data()),{},{users:[]});var n=[];t.data().users.map((function(e){var s=f.doc(e).get().then((function(e){return R(R({},e.data()),{roomId:t.id,username:e.data().username})}));n.push(s)})),n.map((function(e){return i.push(e)})),c.push(e.getLastMessage(t))})),t.next=11,Promise.all(i);case 11:return t.sent.map((function(e){return o[e.roomId].users.push(e)})),t.next=15,Promise.all(c).then((function(t){return t.map((function(t){return{lastMessage:e.formatLastMessage(t),roomId:t.roomId}}))}));case 15:t.sent.map((function(e){return o[e.roomId].lastMessage=e.lastMessage})),d=[],Object.keys(o).forEach((function(t){var s=o[t],r=s.users.filter((function(t){return t._id!==e.currentUserId}));s.roomName=r.map((function(e){return e.username})).join(", ")||"Myself";var a=1===r.length&&r[0].avatar?r[0].avatar:n("piKZ");d.push(R({},R({roomId:t,avatar:a},s)))})),e.rooms=e.rooms.concat(d),e.loadingRooms=!1,e.rooms.map((function(t,n){return e.listenLastMessage(t,n)})),e.listenUsersOnlineStatus(),e.listenRoomsTypingUsers(s);case 24:case"end":return t.stop()}}),t)})))()},getLastMessage:function(e){return this.messagesRef(e.id).orderBy("timestamp","desc").limit(1).get().then((function(t){var n=[];return t.forEach((function(e){return n.push(e.data())})),R(R({},n[0]),{},{roomId:e.id})}))},listenLastMessage:function(e,t){var n=this,s=this.messagesRef(e.roomId).orderBy("timestamp","desc").limit(1).onSnapshot((function(e){e.forEach((function(e){var s=n.formatLastMessage(e.data());n.rooms[t].lastMessage=s}))}));this.roomsListeners.push(s)},formatLastMessage:function(e){if(e.timestamp){var t=new Date(1e3*e.timestamp.seconds),n=I(t,new Date)?"HH:mm":"DD/MM/YY",s=g(e.timestamp,n);"HH:mm"===n&&(s="Today, ".concat(s));var r=e.content;return e.file&&(r="".concat(e.file.name,".").concat(e.file.type)),R(R({},e),{content:r,timestamp:s,date:e.timestamp.seconds,seen:e.sender_id===this.currentUserId?e.seen:null,new:!(e.sender_id===this.currentUserId||e.seen&&e.seen[this.currentUserId])})}},fetchMessages:function(e){var t=this,n=e.room,s=e.options,r=void 0===s?{}:s;if(r.reset&&this.resetMessages(),this.end&&!this.start)return this.messagesLoaded=!0;var a=this.messagesRef(n.roomId),o=a.orderBy("timestamp","desc").limit(this.perPage);this.start&&(o=o.startAfter(this.start)),this.selectedRoom=n.roomId,o.get().then((function(e){if(t.selectedRoom===n.roomId){e.empty&&(t.messagesLoaded=!0),t.start&&(t.end=t.start),t.start=e.docs[e.docs.length-1];var s=a.orderBy("timestamp");t.start&&(s=s.startAfter(t.start)),t.end&&(s=s.endAt(t.end)),r.reset&&(t.messages=[]),e.forEach((function(e){var s=t.formatMessage(n,e);t.messages.unshift(s)}));var o=s.onSnapshot((function(e){t.listenMessages(e,n)}));t.listeners.push(o)}}))},listenMessages:function(e,t){var n=this;e.forEach((function(e){var s=n.formatMessage(t,e),r=n.messages.findIndex((function(t){return t._id===e.id}));-1===r?n.messages=n.messages.concat([s]):n.$set(n.messages,r,s),n.markMessagesSeen(t,e)}))},markMessagesSeen:function(e,t){t.data().sender_id===this.currentUserId||t.data().seen&&t.data().seen[this.currentUserId]||this.messagesRef(e.roomId).doc(t.id).update(b({},"seen.".concat(this.currentUserId),new Date))},formatMessage:function(e,t){var n=e.users.find((function(e){return t.data().sender_id===e._id})),s=t.data(),r=s.sender_id,a=s.timestamp;return R(R({},t.data()),{sender_id:r,_id:t.id,seconds:a.seconds,timestamp:g(a,"HH:mm"),date:g(a,"DD MMMM YYYY"),username:n?n.username:null})},sendMessage:function(e){var t=this;return U(r.a.mark((function n(){var s,a,o,i,c,d,u;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=e.content,a=e.roomId,o=e.file,i=e.replyMessage,c={sender_id:t.currentUserId,content:s,timestamp:new Date},o&&(c.file={name:o.name,size:o.size,type:o.type,url:o.localUrl}),i&&(c.replyMessage={_id:i._id,content:i.content,sender_id:i.sender_id},i.file&&(c.replyMessage.file=i.file)),n.next=6,t.messagesRef(a).add(c);case 6:d=n.sent,u=d.id,o&&t.uploadFile({file:o,messageId:u,roomId:a});case 9:case"end":return n.stop()}}),n)})))()},openFile:function(e){var t=e.message;e.action;window.open(t.file.url,"_blank")},editMessage:function(e){var t=this;return U(r.a.mark((function n(){var s,a,o,i,c;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=e.messageId,a=e.newContent,o=e.roomId,i=e.file,(c={edited:new Date}).content=a,c.file=i?{name:i.name,size:i.size,type:i.type,url:i.url||i.localUrl}:h,n.next=6,t.messagesRef(o).doc(s).update(c);case 6:case"end":return n.stop()}}),n)})))()},deleteMessage:function(e){var t=this;return U(r.a.mark((function n(){var s,a;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=e.messageId,a=e.roomId,n.next=3,t.messagesRef(a).doc(s).update({deleted:new Date});case 3:case"end":return n.stop()}}),n)})))()},uploadFile:function(e){var t=this;return U(r.a.mark((function n(){var s,a,o,i,c;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=e.file,a=e.messageId,o=e.roomId,i=p.child(t.currentUserId).child(a).child("".concat(s.name,".").concat(s.type)),n.next=4,i.put(s.blob,{contentType:s.type});case 4:return n.next=6,i.getDownloadURL();case 6:return c=n.sent,n.next=9,t.messagesRef(o).doc(a).update(b({},"file.url",c));case 9:case"end":return n.stop()}}),n)})))()},menuActionHandler:function(e){var t=e.action,n=e.roomId;switch(t.name){case"inviteUser":return this.inviteUser(n);case"removeUser":return this.removeUser(n);case"deleteRoom":return this.deleteRoom(n)}},messageActionHandler:function(){},sendMessageReaction:function(e){var t=this;return U(r.a.mark((function n(){var s,a,o,i,c;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=e.reaction,a=e.remove,o=e.messageId,i=e.roomId,c=a?d.firestore.FieldValue.arrayRemove(t.currentUserId):d.firestore.FieldValue.arrayUnion(t.currentUserId),n.next=4,t.messagesRef(i).doc(o).update(b({},"reactions.".concat(s.name),c));case 4:case"end":return n.stop()}}),n)})))()},typingMessage:function(e){var t=e.message,n=e.roomId,s=t?d.firestore.FieldValue.arrayUnion(this.currentUserId):d.firestore.FieldValue.arrayRemove(this.currentUserId);l.doc(n).update({typingUsers:s})},listenRoomsTypingUsers:function(e){var t=this;return U(r.a.mark((function n(){return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:e.onSnapshot((function(e){e.forEach((function(e){var n=t.rooms.find((function(t){return t.roomId===e.id}));n&&(n.typingUsers=e.data().typingUsers)}))}));case 1:case"end":return n.stop()}}),n)})))()},updateUserOnlineStatus:function(){var e=d.database().ref("/status/"+this.currentUserId),t={state:"offline",last_changed:d.database.ServerValue.TIMESTAMP},n={state:"online",last_changed:d.database.ServerValue.TIMESTAMP};d.database().ref(".info/connected").on("value",(function(s){0!=s.val()&&e.onDisconnect().set(t).then((function(){e.set(n)}))}))},listenUsersOnlineStatus:function(){var e=this;this.rooms.map((function(t){t.users.map((function(n){d.database().ref("/status/"+n._id).on("value",(function(s){if(s.val()){var r=I(new Date(s.val().last_changed),new Date)?"HH:mm":"DD MMMM, HH:mm",a=g(new Date(s.val().last_changed),r),o="HH:mm"===r?"today, ".concat(a):a;n.status=R(R({},s.val()),{},{last_changed:o});var i=e.rooms.findIndex((function(e){return t.roomId===e.roomId}));e.$set(e.rooms,i,t)}}))}))}))},addRoom:function(){var e=this;this.resetForms(),this.$buefy.dialog.prompt({message:this.trans.get("auth.username"),confirmText:this.trans.get("general.add"),cancelText:this.trans.get("general.cancel"),trapFocus:!0,onConfirm:function(t){t=t.replace("@",""),axios.post("/users/chat",{username:t}).then((function(t){e.createRoom(t.data.id,t.data.username)})).catch((function(t){a.default.toast(e,e.trans.get("utils.user_not_exists"),M.a.ERROR)}))}})},createRoom:function(e,t){var n=this;return U(r.a.mark((function s(){return r.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return n.disableForm=!0,s.next=3,f.doc(""+e).set({_id:e,username:t});case 3:return s.next=5,l.add({users:[""+e,n.currentUserId]});case 5:n.fetchRooms();case 6:case"end":return s.stop()}}),s)})))()},inviteUser:function(e){this.resetForms(),this.inviteRoomId=e},addRoomUser:function(){return U(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},removeUser:function(e){this.resetForms(),this.removeRoomId=e,this.removeUsers=this.rooms.find((function(t){return t.roomId===e})).users},deleteRoomUser:function(){var e=this;return U(r.a.mark((function t(){return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.disableForm=!0,t.next=3,l.doc(e.removeRoomId).update({users:d.firestore.FieldValue.arrayRemove(e.removeUserId)});case 3:e.removeRoomId=null,e.removeUserId="",e.fetchRooms();case 6:case"end":return t.stop()}}),t)})))()},deleteRoom:function(e){var t=this;return U(r.a.mark((function n(){var s;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return(s=t.messagesRef(e)).get().then((function(e){e.empty||e.docs.map((function(e){return s.doc(e.id).delete()}))})),n.next=4,l.doc(e).delete();case 4:t.fetchRooms();case 5:case"end":return n.stop()}}),n)})))()},resetForms:function(){this.disableForm=!1,this.addNewRoom=null,this.addRoomUsername="",this.inviteRoomId=null,this.invitedUsername="",this.removeRoomId=null,this.removeUserId=""}}},D=(n("8V47"),n("KHd+")),_=Object(D.a)(x,(function(){var e=this,t=e.$createElement;return(e._self._c||t)("chat-window",{attrs:{height:"calc(100vh - 56px)",styles:e.styles,currentUserId:e.currentUserId,rooms:e.rooms,loadingRooms:e.loadingRooms,messages:e.messages,messagesLoaded:e.messagesLoaded,menuActions:e.menuActions},on:{fetchMessages:e.fetchMessages,sendMessage:e.sendMessage,editMessage:e.editMessage,deleteMessage:e.deleteMessage,openFile:e.openFile,addRoom:e.addRoom,menuActionHandler:e.menuActionHandler,messageActionHandler:e.messageActionHandler,sendMessageReaction:e.sendMessageReaction,typingMessage:e.typingMessage}})}),[],!1,null,"7486873d",null);t.default=_.exports},cgQY:function(e,t,n){(e.exports=n("I1BE")(!1)).push([e.i,".window-container[data-v-7486873d]{width:100%}.chat-forms[data-v-7486873d]{padding-bottom:20px}.chat-forms form[data-v-7486873d]{padding-top:20px}.chat-forms input[data-v-7486873d]{padding:5px;width:180px;height:21px;border-radius:4px;border:1px solid #d2d6da;outline:none;font-size:14px;vertical-align:middle}.chat-forms input[data-v-7486873d]::-moz-placeholder{color:#9ca6af}.chat-forms input[data-v-7486873d]:-ms-input-placeholder{color:#9ca6af}.chat-forms input[data-v-7486873d]::placeholder{color:#9ca6af}.chat-forms button[data-v-7486873d]{background:#1976d2;color:#fff;outline:none;cursor:pointer;border-radius:4px;padding:8px 12px;margin-left:10px;border:none;font-size:14px;transition:.3s;vertical-align:middle}.chat-forms button[data-v-7486873d]:hover{opacity:.8}.chat-forms button[data-v-7486873d]:active{opacity:.6}.chat-forms button[data-v-7486873d]:disabled{cursor:auto;background:#c6c9cc;opacity:.6}.chat-forms .button-cancel[data-v-7486873d]{color:#a8aeb3;background:none;margin-left:5px}.chat-forms select[data-v-7486873d]{vertical-align:middle;height:33px;width:120px;font-size:13px}",""])},piKZ:function(e,t){e.exports="/images/no_group_avatar.png?f5ae032089871a0cad251c5e3f90bd5b"}}]);